<form version="1.1">
  <label>Database Security - Authentication</label>
  <description>Monitorowanie uwierzytelnie≈Ñ i pr√≥b dostƒôpu do baz danych (podzielone per baza)</description>

  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_token">
      <label>Zakres czasu</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- ========================================================================== -->
  <!-- POSTGRESQL SECTION HEADER -->
  <!-- ========================================================================== -->
  <row>
    <panel>
      <html>
        <div style="
            background:#1e3a8a;
            color:white;
            padding:16px;
            text-align:center;
            font-size:26px;
            font-weight:bold;
            border-radius:8px;
            margin-top:20px;
            margin-bottom:10px;">
          üêò POSTGRESQL ‚Äî AUTHENTICATION OVERVIEW
        </div>
      </html>
    </panel>
  </row>

  <!-- ==================== PostgreSQL: Statystyki ==================== -->
  <row>
    <panel>
      <title>PostgreSQL - Udane logowania</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=postgres "connection authorized"
| rex "\"user\":\"(?<user>[^\"]+)\""
| rex "\"application_name\":\"(?<app>[^\"]+)\""
| search NOT pg_isready
| stats count AS successful_logins by user
| sort -successful_logins
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="dataOverlayMode">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>

    <panel>
      <title>PostgreSQL - Nieudane logowania</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=postgres "password authentication failed"
| rex "\"user\":\"(?<user>[^\"]+)\""
| where isnotnull(user) AND user!=""
| stats count AS failed_logins by user
| sort -failed_logins
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="dataOverlayMode">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>

  <!-- ==================== PostgreSQL: Timeline ==================== -->
  <row>
    <panel>
      <title>PostgreSQL - Udane logowania w czasie</title>
      <chart>
        <search>
          <query>
            <![CDATA[
index=postgres "connection authorized"
| rex "\"user\":\"(?<user>[^\"]+)\""
| rex "\"application_name\":\"(?<app>[^\"]+)\""
| search NOT pg_isready
| timechart span=5m count AS successful_logins by user
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">Czas</option>
        <option name="charting.axisTitleY.text">Liczba udanych logowa≈Ñ</option>
      </chart>
    </panel>

    <panel>
      <title>PostgreSQL - Nieudane logowania w czasie</title>
      <chart>
        <search>
          <query>
            <![CDATA[
index=postgres "password authentication failed"
| rex "\"user\":\"(?<user>[^\"]+)\""
| where isnotnull(user) AND user!=""
| timechart span=5m count AS failed_logins by user
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">Czas</option>
        <option name="charting.axisTitleY.text">Liczba nieudanych logowa≈Ñ</option>
      </chart>
    </panel>
  </row>

  <!-- ==================== PostgreSQL: Szczeg√≥≈Çy ==================== -->
  <row>
    <panel>
      <title>PostgreSQL - Nieudane pr√≥by logowania (szczeg√≥≈Çy)</title>
      <table>
        <search>
          <query>
index=postgres "password authentication failed"
| spath user
| spath dbname
| spath message
| spath remote_host
| spath remote_port
| spath pid
| spath session_id
| spath ps
| spath error_severity
| spath detail
| spath backend_type
| spath query_id
| where isnotnull(user) AND user!=""
| eval status="‚ùå NIEUDANE"
| table _time, status, user, dbname, remote_host, remote_port, pid, session_id, ps, error_severity, detail, backend_type, query_id, message
| sort -_time
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">10</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>PostgreSQL - Udane logowania (szczeg√≥≈Çy)</title>
      <table>
        <search>
          <query>
index=postgres "connection authorized"
| spath user
| spath dbname
| spath application_name
| spath remote_host
| spath remote_port
| spath pid
| spath session_id
| spath ps
| spath error_severity
| spath backend_type
| spath query_id
| search NOT pg_isready
| where isnotnull(user) AND user!=""
| eval status="‚úÖ UDANE"
| table _time, status, user, dbname, application_name, remote_host, remote_port, pid, session_id, ps, error_severity, backend_type, query_id, message
| sort -_time
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">10</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>PostgreSQL - Wielokrotne nieudane pr√≥by logowania</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=postgres "password authentication failed"
| spath user
| spath session_id
| where isnotnull(user) AND user!=""
| bin _time span=1m
| stats dc(session_id) AS failed_logins by _time, user
| eval status=if(failed_logins >= 5, "WARNING", "OK")
| sort -_time
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">10</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="failed_logins">
          <colorPalette type="minMidMax" maxColor="#D93F3C" midColor="#F7BC38" minColor="#65A637"></colorPalette>
          <scale type="minMidMax" midValue="5" minValue="1"></scale>
        </format>
      </table>
    </panel>
  </row>


  <!-- ========================================================================== -->
  <!-- MARIADB SECTION HEADER -->
  <!-- ========================================================================== -->
  <row>
    <panel>
      <html>
        <div style="
          background:#0e7490;
          color:white;
          padding:16px;
          text-align:center;
          font-size:26px;
          font-weight:bold;
          border-radius:8px;
          margin-top:20px;
          margin-bottom:10px;">
          üê¨ MARIADB ‚Äî AUTHENTICATION OVERVIEW
        </div>
      </html>
    </panel>
  </row>

  <!-- ==================== MariaDB Statystyki ==================== -->
  <row>
    <panel>
      <title>MariaDB - Udane logowania</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=mariadb
| rex "^(?<timestamp>\d+\s+\d+:\d+:\d+),[^,]+,(?<user>[^,]+),[^,]+,[^,]+,[^,]+,[^,]+,[^,]*,[^,]*,(?<error_code>\d+)$"
| search NOT healthcheck
| search NOT FAILED_CONNECT
| search CONNECT
| stats count AS successful_logins by user
| sort -successful_logins
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
      </table>
    </panel>

    <panel>
      <title>MariaDB - Nieudane logowania</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=mariadb
| rex "^(?<timestamp>\d+\s+\d+:\d+:\d+),[^,]+,(?<user>[^,]+),[^,]+,[^,]+,[^,]+,[^,]+,[^,]*,[^,]*,(?<error_code>\d+)$"
| search error_code="1045"
| stats count AS failed_logins by user
| sort -failed_logins
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
      </table>
    </panel>
  </row>

  <!-- ==================== MariaDB brute-force ==================== -->
  <row>
    <panel>
      <title>MariaDB - Wielokrotne nieudane pr√≥by logowania</title>
      <table>
        <search>
          <query>
            <![CDATA[
index=mariadb
| rex "^(?<timestamp>\d+\s+\d+:\d+:\d+),[^,]+,(?<target_user>[^,]+),[^,]+,[^,]+,[^,]+,[^,]*,[^,]*,[^,]*,(?<error_code>\d+)$"
| search NOT healthcheck
| search FAILED_CONNECT OR error_code="1045"
| bin _time span=1m
| stats count AS failed_logins by _time, target_user
| eval status=if(failed_logins >= 5, "WARNING", "OK")
| sort -_time
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">10</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="failed_logins">
          <colorPalette type="minMidMax" maxColor="#D93F3C" midColor="#F7BC38" minColor="#65A637"></colorPalette>
          <scale type="minMidMax" midValue="5" minValue="1"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- ==================== MariaDB Timelines ==================== -->
  <row>
    <panel>
      <title>MariaDB - Timeline logowa≈Ñ (Nieudane)</title>
      <chart>
        <search>
          <query>
            <![CDATA[
index=mariadb
| rex "^(?<timestamp>\d+\s+\d+:\d+:\d+),[^,]+,(?<user>[^,]+),[^,]+,[^,]+,[^,]+,[^,]+,[^,]*,[^,]*,(?<error_code>\d+)$"
| search NOT healthcheck
| search error_code="1045"
| eval status="B≈Çƒôdne has≈Ço (1045)"
| timechart span=5m count by user
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>

    <panel>
      <title>MariaDB - Timeline logowa≈Ñ (Udane)</title>
      <chart>
        <search>
          <query>
            <![CDATA[
index=mariadb
| rex "^(?<timestamp>\d+\s+\d+:\d+:\d+),[^,]+,(?<user>[^,]+),[^,]+,[^,]+,[^,]+,[^,]+,[^,]*,[^,]*,(?<error_code>\d+)$"
| search NOT healthcheck
| search NOT FAILED_CONNECT
| search CONNECT
| timechart span=5m count by user
            ]]>
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
  </row>

  <!-- ==================== MariaDB Logs ==================== -->
  <row>
    <panel>
      <title>MariaDB - Ostatnie udane logowania</title>
      <table>
        <search>
          <query><![CDATA[
index=mariadb
| rex "^(?<timestamp>\d+\s+\d+:\d+:\d+),[^,]+,(?<user>[^,]+),(?<host>[^,]+),(?<connection_id>[^,]+),(?<query_id>[^,]+),(?<action>[^,]+),(?<database>[^,]*),(?<object>[^,]*),(?<error_code>\d+)$"
| search NOT healthcheck
| search NOT FAILED_CONNECT
| search action="CONNECT"
| eval status="‚úÖ Udane logowanie"
| table timestamp, user, host, connection_id, query_id, action, database, object, error_code, status
| sort -timestamp
          ]]></query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>MariaDB - Ostatnie nieudane logowania</title>
      <table>
        <search>
          <query><![CDATA[
index=mariadb
| rex "^(?<timestamp>\d+\s+\d+:\d+:\d+),[^,]+,(?<user>[^,]+),[^,]+,[^,]+,[^,]+,[^,]+,[^,]*,[^,]*,(?<error_code>\d+)$"
| search NOT healthcheck
| search error_code="1045"
| eval status="B≈Çƒôdne has≈Ço (1045)"
          ]]></query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
      </table>
    </panel>
  </row>


  <!-- ========================================================================== -->
  <!-- MONGODB SECTION HEADER -->
  <!-- ========================================================================== -->
  <row>
    <panel>
      <html>
        <div style="
          background:#166534;
          color:white;
          padding:16px;
          text-align:center;
          font-size:26px;
          font-weight:bold;
          border-radius:8px;
          margin-top:20px;
          margin-bottom:10px;">
          üçÉ MONGODB ‚Äî AUTHENTICATION OVERVIEW
        </div>
      </html>
    </panel>
  </row>

  <!-- ==================== MongoDB Statystyki ==================== -->
  <row>
    <panel>
      <title>MongoDB - Udane logowania</title>
      <table>
        <search>
          <query><![CDATA[
index=mongodb "Successfully authenticated"
| rex "\"user\":\"(?<user>[^\"]+)\""
| where isnotnull(user) AND user!=""
| bin _time span=2s
| stats dc(_time) AS successful_logins by user
| sort -successful_logins
          ]]></query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="rowNumbers">true</option>
        <option name="count">10</option>
      </table>
    </panel>

    <panel>
      <title>MongoDB - Nieudane logowania</title>
      <table>
        <search>
          <query><![CDATA[
index=mongodb "Failed to authenticate"
| rex "\"user\":\"(?<user>[^\"]+)\""
| where isnotnull(user) AND user!=""
| bin _time span=2s
| stats dc(_time) AS failed_logins by user
| sort -failed_logins
          ]]></query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>

  <!-- ==================== MongoDB Timeline ==================== -->
  <row>
    <panel>
      <title>MongoDB - Timeline (Nieudane)</title>
      <chart>
        <search>
          <query><![CDATA[
index=mongodb "Failed to authenticate"
| rex "\"user\":\"(?<user>[^\"]+)\""
| where isnotnull(user) AND user!=""
| bin _time span=5m
| timechart span=5m count by user
          ]]></query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
      </chart>
    </panel>

    <panel>
      <title>MongoDB - Timeline (Udane)</title>
      <chart>
        <search>
          <query><![CDATA[
index=mongodb "Successfully authenticated"
| rex "\"user\":\"(?<user>[^\"]+)\""
| where isnotnull(user) AND user!=""
| bin _time span=5m
| stats count AS raw_logs by _time, user
| eval successful_logins=round(raw_logs/3,0)
| timechart span=5m sum(successful_logins) by user
          ]]></query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
      </chart>
    </panel>
  </row>

  <!-- ==================== MongoDB Logs ==================== -->
  <row>
    <panel>
      <title>MongoDB - Ostatnie udane logowania</title>
      <table>
        <search>
          <query><![CDATA[
index=mongodb "Successfully authenticated"
| rex "\"user\":\"(?<user>[^\"]+)\""
| rex "\"db\":\"(?<database>[^\"]+)\""
| rex "(?<client_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})"
| where isnotnull(user) AND user!=""
| eval status="‚úÖ UDANE"
| table _time, status, user, database, client_ip, _raw
| sort -_time
          ]]></query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>MongoDB - Ostatnie nieudane logowania</title>
      <table>
        <search>
          <query><![CDATA[
index=mongodb "Failed to authenticate"
| rex "\"user\":\"(?<user>[^\"]+)\""
| rex "\"db\":\"(?<database>[^\"]+)\""
| rex "(?<client_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})"
| where isnotnull(user) AND user!=""
| eval status="‚ùå NIEUDANE"
| table _time, status, user, database, client_ip, _raw
| sort -_time
          ]]></query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
      </table>
    </panel>
  </row>

  <!-- ==================== MongoDB brute force ==================== -->
  <row>
    <panel>
      <title>MongoDB - Wielokrotne nieudane pr√≥by</title>
      <table>
        <search>
          <query><![CDATA[
index=mongodb "Failed to authenticate"
| rex "\"user\":\"(?<user>[^\"]+)\""
| rex "\"ctx\":\"(?<ctx>[^\"]+)\""
| where isnotnull(user) AND user!=""
| bin _time span=1m
| stats dc(ctx) AS failed_logins by _time, user
| eval failed_logins = tonumber(failed_logins)
| eval status = if(failed_logins >= 5, "WARNING", "OK")
| sort -_time
          ]]></query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="rowNumbers">true</option>
        <format type="color" field="failed_logins">
          <colorPalette type="minMidMax" maxColor="#D93F3C" midColor="#F7BC38" minColor="#65A637"></colorPalette>
          <scale type="minMidMax" midValue="5" minValue="1"></scale>
        </format>
      </table>
    </panel>
  </row>

</form>